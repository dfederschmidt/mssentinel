## Authentication

POST login.microsoftonline.com/{{tenant_id}}/oauth2/v2.0/token HTTP/1.1
Content-Type: application/x-www-form-urlencoded

client_id={{client_id}}
&scope=https://management.azure.com/.default
&client_secret={{client_secret}}
&grant_type=client_credentials

### Authentication Loganalytics
POST login.microsoftonline.com/{{tenant_id}}/oauth2/token HTTP/1.1
Content-Type: application/x-www-form-urlencoded

client_id={{client_id}}
&resource=https://api.loganalytics.io
&client_secret={{client_secret}}
&grant_type=client_credentials


###  List Incidents

GET https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource_group}}/providers/Microsoft.OperationalInsights/workspaces/{{workspace_name}}/providers/Microsoft.SecurityInsights/incidents?api-version=2022-08-01
Authorization: Bearer {{token}}

### Get individual incident
GET https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource_group}}/providers/Microsoft.OperationalInsights/workspaces/{{workspace_name}}/providers/Microsoft.SecurityInsights/incidents/1662017910?api-version=2021-04-01
Authorization: Bearer {{token}}
Content-Type: application/json

### Create Incident
PUT https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource_group}}/providers/Microsoft.OperationalInsights/workspaces/{{workspace_name}}/providers/Microsoft.SecurityInsights/incidents/{{$timestamp}}?api-version=2021-10-01
Authorization: Bearer {{token}}
Content-Type: application/json

{
    "properties": {
        "severity": "Informational",
        "status": "New",
        "title": "My incident from SOAR"
    }
}

### Update Incident Status - need to get first and then push
PUT https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource_group}}/providers/Microsoft.OperationalInsights/workspaces/{{workspace_name}}/providers/Microsoft.SecurityInsights/incidents/1661855486?api-version=2021-10-01
Authorization: Bearer {{token}}
Content-Type: application/json

{
    "properties": {
        "severity": "Informational",
        "status": "Active",
        "title": "new title"
    }
}

### Get comments for incident
GET https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource_group}}/providers/Microsoft.OperationalInsights/workspaces/{{workspace_name}}/providers/Microsoft.SecurityInsights/incidents/1661855486/comments?api-version=2021-04-01
Authorization: Bearer {{token}}
Content-Type: application/json

### Get individual incident with last updated time eq to X
GET https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource_group}}/providers/Microsoft.OperationalInsights/workspaces/{{workspace_name}}/providers/Microsoft.SecurityInsights/incidents?api-version=2021-04-01&$filter=(properties/lastModifiedTimeUtc eq 2022-08-30T10:26:27.3710349Z)
Authorization: Bearer {{token}}
Content-Type: application/json

### Get all incidents with last updated time ge than X
GET https://management.azure.com/subscriptions/de582eca-4f28-4f8d-9ded-9b0cd2803739/resourceGroups/demomachine_group/providers/Microsoft.OperationalInsights/workspaces/customworkspace/providers/Microsoft.SecurityInsights/incidents?api-version=2021-04-01&$top=50&$filter=(properties/lastModifiedTimeUtc ge 2022-08-30T11:35:05Z)
Authorization: Bearer {{token}}
Content-Type: application/json

### Paginated
GET https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource_group}}/providers/Microsoft.OperationalInsights/workspaces/{{workspace_name}}/providers/Microsoft.SecurityInsights/incidents?api-version=2021-04-01&$top=1
Authorization: Bearer {{token}}


### Update owner
PUT https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource_group}}/providers/Microsoft.OperationalInsights/workspaces/{{workspace_name}}/providers/Microsoft.SecurityInsights/incidents/1662017910?api-version=2021-10-01
Authorization: Bearer {{token}}
Content-Type: application/json

{
    "properties": {
        "title": "new title",
        "severity": "Informational",
        "status": "Active",
        "owner": {
            "userPrincipalName": "dfederschmidt@splunk.com"
        }
    }
}

###
POST https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource_group}}/providers/Microsoft.OperationalInsights/workspaces/{{workspace_name}}/providers/Microsoft.SecurityInsights/incidents/1662017910/entities?api-version=2021-10-01
Authorization: Bearer {{token}}


### Query Log Analytics Workspace

POST https://api.loganalytics.io/v1/workspaces/0eefde87-49fe-484a-b408-1d9225e1573d/query
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGxWMFRPSSIsImtpZCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGxWMFRPSSJ9.eyJhdWQiOiJodHRwczovL2FwaS5sb2dhbmFseXRpY3MuaW8iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC84YWRkNzgxMC1iNjJhLTRmYzAtYmJiYi0yMDE2NWQxODNkN2YvIiwiaWF0IjoxNjY1NTczODE5LCJuYmYiOjE2NjU1NzM4MTksImV4cCI6MTY2NTU3NzcxOSwiYWlvIjoiRTJaZ1lHajg1QlJ1M3ZrL2ZGZjNvNWtId3RwOUFRPT0iLCJhcHBpZCI6IjQ5OGY5ZjhkLWJkOWQtNDgxOS05MWU0LWE0ZTBmODJiYmM1ZSIsImFwcGlkYWNyIjoiMSIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzhhZGQ3ODEwLWI2MmEtNGZjMC1iYmJiLTIwMTY1ZDE4M2Q3Zi8iLCJvaWQiOiJkNzVjMGQ3Ni03MDI4LTQxY2MtYTcwZC1kNTM4YjE3YzkwMjciLCJyaCI6IjAuQVNjQUVIamRpaXEyd0UtN3V5QVdYUmc5ZndzX2Y4cVJmU3hJamduRjJFRFE2c1VuQUFBLiIsInN1YiI6ImQ3NWMwZDc2LTcwMjgtNDFjYy1hNzBkLWQ1MzhiMTdjOTAyNyIsInRpZCI6IjhhZGQ3ODEwLWI2MmEtNGZjMC1iYmJiLTIwMTY1ZDE4M2Q3ZiIsInV0aSI6Il8wV3gtVTI4cDBtaEozY3JVSVFmQUEiLCJ2ZXIiOiIxLjAifQ.oq9KXt_sw2YLpF1e1Abw9KDpBVrfD2mweyvHxF9tFaxdFRp_zvpYUA_JvCjSsraloa6q2V3B3mje4dKezZKbw_FqyLIx40LLuHv8-IowsGPs7-tS2Kjfwdh-PMukWop1KNTfyhV2CjiiMHhsl6dN0xNnZNQRcsxkWhBEGbjIhQqgiLGd_X2lk32pzVhcwopusbo-IiTf9Am312tKw1QajpCsEOjFY5cqqPzqRVdJ3UwYax3T1t-aY13vtRpk88NP2ZpVU9nTjo0CC-hGXuCFPqZtVBL1RY8V3IgJ0kHubWu8XB6byHqfGJyQ8fUz5v27X4hx1_F1M317JF7GFlCTjg
Content-Type: application/json
Accept: application/json

{
        "maxRows": 1,
        "query": "SecurityIncident | where TimeGenerated >= ago(60d)",
        "workspaceFilters": {
            "regions": []
        }
}